#!/usr/bin/env python
# model_view_controller.py
import app.exceptions as exc
from pymongo import MongoClient
from collections import OrderedDict
import sys
import urllib.request
import shutil
import gridfs
import mimetypes

class Model(object):

    def __init__(self):
        self._client = MongoClient('mongodb://127.0.0.1:27017')
        self._db = self._client.crawler_malware
        self.initialisation()

    def initialisation(self):
        self.create_collections()
        self.erase_gridfs()

    @property
    def connection(self):
        return self._db

    def erase_gridfs(self):
        """
        Erase gridfs database
        Params:
        -none
        Returns:
        - none
        """
        fs = gridfs.GridFSBucket(self._db)
        for gridout in fs.find():
            fs.delete(gridout._id)

    def create_collections(self):
        """
        Create collection
        Params:
        - db
        Returns:
        - none
        """
        self.create_malware_collection()
        self.create_vt_collection()
        self.create_label_collection()
        self.create_ip_collection()


    def create_malware_collection(self):

        """
        add atribute in malware collection
        Params:
        - db
        Returns:
        - none
        """
        self._db.malware_collection.drop()
        self._db.create_collection( "malware_collection")

        vexpr = {
            "$jsonSchema": {
                "bsonType": "object",
            "uniqueItems": True,
                "required": [ "id_malware" ],
                "properties": {
                    "id_malware": {
                    "bsonType": "string",
                    },
                    "source_malware": {
                    "bsonType": "string",
                    },
                    "date_added_malware": {
                    "bsonType": "string",
                    },
                    "url_malware": {
                    "bsonType": "string",
                    },
                    "url_status_malware": {
                    "bsonType": "bool",
                    },
                    "threat_malware": {
                    "bsonType": "string",
                    },
                    "tags_malware": {
                    "bsonType": "string",
                    },
                    "url_haus_malware":{
                    "bsonType": "string",
                    },
                    "reporter_malware": {
                    "bsonType": "string",
                    },
                    "md5_malware": {
                    "bsonType": "string",
                    },
                    "sha256_malware": {
                    "bsonType": "string",
                    },
                    "sha1_malware": {
                    "bsonType": "string",
                    },
                    "ssdeep_malware": {
                    "bsonType": "string",
                    },
                    "is_exe_malware": {
                    "bsonType": "bool",
                    },
                    "imphash_malware": {
                    "bsonType": "string",
                    },
                    "vt_report_malware": {
                    "bsonType": "bool"
                    }
            }
            }
        }

        cmd = OrderedDict([('collMod', 'malware_collection'),
            ('validator', vexpr),
            ('validationLevel', 'moderate')])

        self._db.command(cmd)

        self._db.malware_collection.create_index("id_malware")

    def create_vt_collection(self):

        """
        add atribute in virus total collection
        Params:
        - db
        Returns:
        - none
        """

        self._db.vt_collection.drop()
        self._db.create_collection("vt_collection")

        vexpr = {
            "$jsonSchema": {
                "bsonType": "object",
                "required": [ "id_malware_vt" ],
                "properties": {
                    "scan_id_vt" : {
                       "bsonType" : "string"
                    },
                    "total_scan_vt" : {
                       "bsonType": "int",
                    },
                    "positives_vt" : {
                       "bsonType": "int",
                    },
                    "resource_vt" : {
                       "bsonType": "string",
                    },
                    "response_vt" : {
                       "bsonType": "int",
                    },
                    "scan_date_vt" : {
                       "bsonType": "string",
                    },
                    "permalink_vt" : {
                       "bsonType": "string",
                    },
                    "sha256_vt" : {
                       "bsonType": "string",
                    },
                    "sha1_vt" : {
                       "bsonType": "string",
                    },
                    "md5_vt" : {
                      "bsonType": "string",
                    },
                    "entire_report_vt" : {
                      "bsonType": "string",
                    },
                    "id_malware_vt" : {
                       "bsonType": "string",
                    }
                }
            }
        }

        cmd = OrderedDict([('collMod', 'vt_collection'),
                ('validator', vexpr),
            ('validationLevel', 'moderate')])

        self._db.command(cmd)

        self._db.vt_collection.create_index("scan_id_vt")

    def create_label_collection(self):
        """
        add atribute in label collection
        Params:
        - db
        Returns:
        - none
        """

        self._db.label_collection.drop()
        self._db.create_collection( "label_collection")

        vexpr = {
            "$jsonSchema": {
                "bsonType": "object",
                "required": [ "id_malware_label" ],
                "properties": {
                    "id_malware_label" : {
                       "bsonType": "string",
                    },
                    "label" : {
                       "bsonType": "string",
                    }
                }
            }
        }

        cmd = OrderedDict([('collMod', 'label_collection'),
                ('validator', vexpr),
                ('validationLevel', 'moderate')])

        self._db.command(cmd)
        self._db.label_collection.create_index("id_malware_label")

    def create_ip_collection(self):

        """
        add atribute in ip collection
        Params:
        - db
        Returns:
        - none
        """

        self._db.ip_collection.drop()
        self._db.create_collection( "ip_collection")

        vexpr = {
            "$jsonSchema": {
                "bsonType": "object",
                "required": [ "address_ip" ],
                "properties": {
                    "id_malware_ip" : {
                        "bsonType": "string",
                    },
                    "address_ip" : {
                        "bsonType": "string",
                    },
                    "country_name_ip" : {
                        "bsonType": "string",
                    },
                    "continent_code_ip" : {
                        "bsonType": "string",
                    },
                    "continent_name_ip" : {
                        "bsonType": "string",
                    },
                    "country_code_ip" : {
                        "bsonType": "string",
                    },
                    "region_code_ip" : {
                        "bsonType": "string",
                    },
                    "region_name_ip" : {
                        "bsonType" : "string",
                    },
                    "city_ip" : {
                        "bsonType" : "string",
                    },
                    "zip_ip" : {
                        "bsonType" : "string",
                    },
                    "latitute_ip" : {
                        "bsonType" : "double",
                    },
                    "longitute_ip" : {
                        "bsonType" : "double",
                    },
                    "full_report_ip" : {
                        "bsonType" : "string",
                    },
            }
            }
        }

        cmd = OrderedDict([('collMod', 'ip_collection'),
            ('validator', vexpr),
            ('validationLevel', 'moderate')])

        self._db.command(cmd)
        self._db.ip_collection.create_index("address_ip")


    def add_malware_collection(self, id_malware, source_malware, date_added, url_malware, url_status, threat, tags, urlhaus_link, reporter):
        try:
            query = {"id_malware":id_malware,
                    "source_malware":source_malware,
                    "date_added_malware":date_added,
                    "url_malware":url_malware,
                    "url_status_malware":url_status,
                    "threat_malware": threat,
                    "tags_malware": tags,
                    "url_haus_malware":urlhaus_link,
                    "reporter_malware":reporter,
                    "vt_report_malware":False,
            }
            """print(id_malware + str(type(id_malware)))
            print(source_malware + str(type(source_malware)))
            print(date_added + str(type(date_added)))
            print(url_malware + str(type(url_malware)))
            print(url_status + str(type(url_status)))
            print(threat +str(type(threat)))
            print(tags +str(type(tags)))
            print(urlhaus_link +str(type(urlhaus_link)))
            print(reporter +str(type(reporter)))"""
            self._db.malware_collection.insert(query)
            print("All good. File ID " + id_malware + " added to Mongodb")
            return True
        except:
            print("exc:", sys.exc_info())


    def select_one_malware_collection(self, id_malware):
        return self._db.malware_collection.findOne( { "id_malware": id_malware })

    def select_all_malware_collection(self):
        return self._db.malware_collection.find()

    def delete_one_malware_collection(self, id_malware):
        self._db.malware_collection.deleteOne( { "id_malware": id_malware } )

    def add_vt_collection(self, scan_id_vt, total_scan_vt, positives_vt, resource_vt, response_vt, scan_date_vt, permalinks_vt, sha256_vt, md5_vt, sha1_vt, entire_report_vt, id_malware_vt):
        try:
            query = {"scan_id_vt": scan_id_vt,
                     "total_scan_vt":total_scan_vt,
                     "positives_vt": positives_vt,
                     "response_vt":response_vt,
                     "resource_vt":resource_vt,
                     "scan_date_vt":scan_date_vt,
                     "permalinks_vt": permalinks_vt,
                     "sha256_vt": sha256_vt,
                     "sha1_vt": sha1_vt,
                     "md5_vt":md5_vt,
                     "entire_report_vt":entire_report_vt,
                     "id_malware_vt":id_malware_vt,
            }
            self._db.vt_collection.insert(query)
            print("All good.")
        except:
            print("exc:", sys.exc_info())

    def select_one_vt_collection(self,scan_id_vt):
        return self._db.vt_collection.findOne( { "id_vt": id_vt })

    def select_all_vt_collection(self):
        return self._db.vt_collection.find()

    def delete_one_vt_collection(self,scan_id_vt):
        self._db.vt_collection.deleteOne( { "scan_id_vt": scan_id_vt } )

    def add_label_collection(self,id_malware_label, output_avclassplusplus):

        try:
            query = {"id_malware_label": id_malware_label,
                     "label": output_avclassplusplus,
            }
            self._db.label_collection.insert(query)
            print("All good.")
        except:
            print("exc:", sys.exc_info())

    def select_one_label_collection(self,id_malware_label):
        return self._db.label_collection.findOne( { "id_label": id_malware_label })

    def select_all_label_collection(self):
        return self._db.label_collection.find()

    def delete_one_label_collection(self,id_malware_label):
        self._db.label_collection.deleteOne( { "id_malware_label": id_malware_label } )

    def add_ip_collection(self,id_malware_ip, ip, country_name, country_code, continent_code, continent_name,region_name, region_code, city, zip, latitude, longitude, full_report):

        try:
            query = {"id_malware_ip": id_malware_ip,
                    "address_ip":ip,
                    "country_name_ip": country_name,
                    "country_code_ip":country_code,
                    "continent_name_ip":continent_name,
                    "continent_code_ip":continent_code,
                    "region_name_ip":region_name,
                    "region_code_ip":region_code,
                    "city_ip":city,
                    "zip_ip":zip,
                    "latitude_ip":latitude,
                    "longitude_ip":longitude,
                    "full_report_ip":full_report,
            }
            self._db.ip_collection.insert(query)
            print("All good.")
        except:
            print("exc:", sys.exc_info())

    def select_one_ip_collection(self,id_malware_ip):
        return self._db.ip_collection.findOne( { "id_malware_ip": id_malware_ip })

    def select_all_ip_collection(self):
        return self._db.ip_collection.find()

    def delete_one_ip_collection(self,id_malware_ip):
        self._db.ip_collection.deleteOne( { "id_malware_ip": id_malware_ip } )
