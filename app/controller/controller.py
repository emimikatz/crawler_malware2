import app.exceptions as exc
import csv
import dateutil.parser
import json
import os
import sys
import time
import requests
import logging

from datetime import datetime
from collections import OrderedDict
from pymongo import MongoClient

class Controller(object):

    def __init__(self, model, view):
        self.model = model
        self.view = view

    def break_csv(self, lines):
        for line in lines:
            if line.startswith('#'):
                lines.remove(line)
        reader = csv.reader(lines, quotechar='"',delimiter=',',quoting=csv.QUOTE_ALL, skipinitialspace=True)
        next(reader)
        return reader

    def parse_csv_urlhaus(self,request):
        """
        Parsing csv file from urlhaus
        Params:
        - url: (type: string).
        Returns:
        - name: (type: string).
        """
        print("Parsing csv file from urlhaus...")
        url_list = []
        lines = request.text.split('\n')

        reader = self.break_csv(lines)
        for item in reader:
            if len(item) > 1:
                id_malware, date_added, url_malware, url_status, threat, tags, urlhaus_link, reporter = self.save_infos_from_csv(item)
                self.model.add_malware_collection(id_malware,
                                             "urlhaus",
                                             date_added,
                                             url_malware,
                                             url_status,
                                             threat,
                                             tags,
                                             urlhaus_link,
                                             reporter)

    def init_connection_urlhaus(self):
        """ Initialisation, connection to Url Haus
        Params:
        Returns:
        """
        try:
            logging.info('Fetching latest URLhaus list...')
            request = requests.get('https://urlhaus.abuse.ch/downloads/csv_recent/')
            if request.status_code == 200:
                logging.info('Processing URLhaus list...')
                return request
            else:
                logging.error('Problem connecting to URLhaus. Status code:{0}. Please try again later.'.format(request.status_code))

        except requests.exceptions.ConnectionError as e: logging.warning('Problem connecting to URLhaus. Error: {0}'.format(e))

        except Exception as e:
            logging.warning('Problem connecting to URLhaus. Aborting task.')
            logging.exception(sys.exc_info())
            logging.exception(type(e))
            logging.exception(e.args)
            logging.exception(e)

        return []

    def clean_url(self, url):
        """Remove extraneous characters from URL.
        Params:
        - url: (type: string) URL to clean.
        Returns:
        - url: (type: string) clean URL.
        """

        if url is None:
            return None

        if '??' in url:
            url = url.split('??')[0]

        if url.endswith('?'):
            url = url[:-1]

        if '`' in url:
            url = url.replace('`', '')

        return url

    def get_name_file_from_url(self, url):
        """
        Get name file from url
        Params:
        - url: (type: string).
        Returns:
        - name: (type: string).
        """

        print("\nSearching for filename from url...")
        last_slash = url.rfind('/')
        return url[last_slash+1:]
        print("\nDone.")

    def save_infos_from_csv(self,item):
        '''
        SAVE INFOS FROM CSV
        Params:
        - item: (type: string) URL.
        Returns:
        - id_malware, date_added, url_malware, url_status, threat, tags, urlhaus_link, reporter.
        '''
        id_malware = item[0]
        date_added = item[1]
        print(item[2])
        url_malware = self.clean_url(item[2])
        if item[3] == "online":
            url_status = True
        else:
            url_status = False
        threat = item[4]
        tags = item[5]
        urlhaus_link = item[6]
        reporter = item[7]
        return id_malware, date_added, url_malware, url_status, threat, tags, urlhaus_link, reporter

    def show_malwares(self, bullet_points=False):
        items = self.model.read_malwares()
        if bullet_points:
            self.view.show_bullet_point_list("malware", items)
        else:
            self.view.show_number_point_list("malware", items)

    def show_malware(self, id_malware):
        try:
            item = self.model.read_malware(id_malware)
            self.view.show_item("malware", id_malware, item)
        except exc.ItemNotStored as e:
            self.view.display_missing_item_error(id_malware, e)

    def insert_malware(self, id_malware, source_malware, date_added, url_malware, url_status, threat, tags, urlhaus_link, reporter_malware):
        try:
            self.model.create_item(id_malware, source_malware, date_added, url_malware, url_status, threat, tags, urlhaus_link, reporter_malware)
            self.view.display_item_stored(id_malware, "malware")
        except exc.ItemAlreadyStored as e:
            self.view.display_item_already_stored_error(id_malware, "malware", e)

    def delete_malware(self, id_malware):
        try:
            self.model.delete_malware(id_malware)
            self.view.display_item_deletion(id_malware)
        except exc.ItemNotStored as e:
            self.view.display_item_not_yet_stored_error(id_malware, "malware", e)

    def show_ips(self, bullet_points=False):
        items = self.model.read_ips()
        if bullet_points:
            self.view.show_bullet_point_list("ip", items)
        else:
            self.view.show_number_point_list("ip", items)

    def show_ip(self, id_malware_ip):
        try:
            item = self.model.read_ip(id_malware_ip)
            self.view.show_item("ip", id_malware_ip, item)
        except exc.ItemNotStored as e:
            self.view.display_missing_item_error(id_malware_ip, e)

    def insert_ip(self, id_malware_ip, ip, country_name, country_code, continent_code, continent_name,region_name, region_code, city, zip, latitude, longitude, full_report):
        try:
            self.model.create_ip(id_malware_ip, ip, country_name, country_code, continent_code, continent_name,region_name, region_code, city, zip, latitude, longitude, full_report)
            self.view.display_item_stored(id_malware_ip, "ip")
        except exc.ItemAlreadyStored as e:
            self.view.display_item_already_stored_error(id_malware_ip, "ip", e)

    def delete_ip(self, id_malware_ip):
        try:
            self.model.delete_ip(id_malware_ip)
            self.view.display_item_deletion(id_malware_ip)
        except exc.ItemNotStored as e:
            self.view.display_item_not_yet_stored_error(id_malware_ip, "ip", e)

    def show_labels(self, bullet_points=False):
        items = self.model.read_labels()
        if bullet_points:
            self.view.show_bullet_point_list("label", items)
        else:
            self.view.show_number_point_list("label", items)

    def show_label(self, id_malware_label):
        try:
            item = self.model.read_ip(id_malware_label)
            self.view.show_item("label", id_malware_label, item)
        except exc.ItemNotStored as e:
            self.view.display_missing_item_error(id_malware_label, e)

    def insert_label(self, id_malware_label, output_avclassplusplus):
        try:
            self.model.create_label(id_malware_label, output_avclassplusplus)
            self.view.display_item_stored(id_malware_label, "label")
        except exc.ItemAlreadyStored as e:
            self.view.display_item_already_stored_error(id_malware_label, "label", e)

    def delete_label(self, id_malware_label):
        try:
            self.model.delete_label(id_malware_label)
            self.view.display_item_deletion(id_malware_label)
        except exc.ItemNotStored as e:
            self.view.display_item_not_yet_stored_error(id_malware_label, "label", e)

    def show_vts(self, bullet_points=False):
        items = self.model.read_vts()
        if bullet_points:
            self.view.show_bullet_point_list("vt", items)
        else:
            self.view.show_number_point_list("vt", items)

    def show_vt(self, scan_id_vt):
        try:
            item = self.model.read_vt(scan_id_vt)
            self.view.show_item("vt", scan_id_vt, item)
        except exc.ItemNotStored as e:
            self.view.display_missing_item_error(scan_id_vt, e)

    def insert_vt(self, scan_id_vt, output_avclassplusplus):
        try:
            self.model.create_vt(scan_id_vt, output_avclassplusplus)
            self.view.display_item_stored(scan_id_vt, "vt")
        except exc.ItemAlreadyStored as e:
            self.view.display_item_already_stored_error(scan_id_vt, "vt", e)

    def delete_vt(self, scan_id_vt):
        try:
            self.model.delete_vt(scan_id_vt)
            self.view.display_item_deletion(scan_id_vt)
        except exc.ItemNotStored as e:
            self.view.display_item_not_yet_stored_error(scan_id_vt, "vt", e)
